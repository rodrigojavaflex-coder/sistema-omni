<div class="audit-logs-container">
  <!-- Cabe√ßalho -->
  <div class="header">
    <h1 class="title">Logs de Auditoria</h1>
    <div class="header-actions">
      <button 
        class="btn btn-outline" 
        (click)="toggleUndoablePanel()"
        [class.active]="showUndoablePanel">
        <span class="icon">‚Ü∂</span>
        Desfazer Altera√ß√µes
      </button>
      <button 
        class="btn btn-outline" 
        (click)="toggleFilters()"
        [class.active]="showFilters">
        <span class="icon">üîç</span>
        Filtros
      </button>
    </div>
  </div>

  <!-- Painel de altera√ß√µes desfa√≠veis -->
  <div class="undoable-panel" [class.show]="showUndoablePanel">
    <div class="panel-header">
      <h3>Altera√ß√µes que podem ser desfeitas</h3>
      <span class="panel-subtitle">√öltimas 24 horas - M√°ximo 10 altera√ß√µes</span>
    </div>

    <div *ngIf="undoableChanges.length === 0" class="empty-undoable">
      <span class="icon">‚úÖ</span>
      <p>Nenhuma altera√ß√£o dispon√≠vel para desfazer</p>
    </div>

    <div *ngIf="undoableChanges.length > 0" class="undoable-list">
      <div *ngFor="let change of undoableChanges" class="undoable-item">
        <div class="undoable-info">
          <div class="undoable-action">
            <span class="action-badge">{{actionDescriptions[change.acao]}}</span>
          </div>
          <div class="undoable-details">
            <div class="undoable-description">{{change.descricao}}</div>
            <div class="undoable-meta">
              <span class="user">{{getUserName(change)}}</span>
              <span class="time">{{formatDate(change.criadoEm)}}</span>
              <span class="time-remaining" [class.expired]="!change.canUndo">
                {{change.canUndo ? 'Expira em: ' + formatTimeRemaining(change) : 'Expirado'}}
              </span>
            </div>
          </div>
        </div>
        <div class="undoable-actions">
          <button 
            class="btn btn-undo" 
            (click)="confirmUndo(change)"
            [disabled]="!change.canUndo || undoingLogId === change.id"
            title="Desfazer esta altera√ß√£o">
            <span *ngIf="undoingLogId === change.id" class="spinner-small"></span>
            <span *ngIf="undoingLogId !== change.id">‚Ü∂ Desfazer</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de busca -->
  <div class="search-bar">
    <input 
      type="text" 
      class="search-input"
      placeholder="Buscar por descri√ß√£o, usu√°rio, IP..." 
      [(ngModel)]="searchText" 
      (ngModelChange)="onSearchChange()">
  </div>

  <!-- Painel de filtros -->
  <div class="filters-panel" [class.show]="showFilters">
    <div class="filters-grid">
      <!-- Usu√°rio -->
      <div class="filter-group">
        <label>Usu√°rio:</label>
        <select [(ngModel)]="selectedUserId" class="filter-select">
          <option value="">Todos os usu√°rios</option>
          <option *ngFor="let user of users" [value]="user.id">
            {{user.nome}}
          </option>
        </select>
      </div>

      <!-- A√ß√£o -->
      <div class="filter-group">
        <label>A√ß√£o:</label>
        <select [(ngModel)]="selectedAction" class="filter-select">
          <option value="">Todas as a√ß√µes</option>
          <option *ngFor="let action of auditActions" [value]="action">
            {{actionDescriptions[action]}}
          </option>
        </select>
      </div>

      <!-- Tipo de Entidade -->
      <div class="filter-group">
        <label>Tipo:</label>
        <input 
          type="text" 
          [(ngModel)]="selectedEntityType" 
          class="filter-input"
          placeholder="Ex: User">
      </div>

      <!-- Data In√≠cio -->
      <div class="filter-group">
        <label>Data In√≠cio:</label>
        <input 
          type="datetime-local" 
          [(ngModel)]="startDate" 
          class="filter-input">
      </div>

      <!-- Data Fim -->
      <div class="filter-group">
        <label>Data Fim:</label>
        <input 
          type="datetime-local" 
          [(ngModel)]="endDate" 
          class="filter-input">
      </div>

      <!-- Bot√µes de a√ß√£o -->
      <div class="filter-actions">
        <button class="btn btn-primary" (click)="applyFilters()">
          Aplicar
        </button>
        <button class="btn btn-outline" (click)="clearFilters()">
          Limpar
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="loading">
      <span class="spinner"></span>
      Carregando logs...
    </div>
  }

  <!-- Error -->
  <div *ngIf="error" class="error">
    {{error}}
  </div>

  <!-- Tabela de logs -->
  <div *ngIf="!loading && !error" class="logs-table-container">
    <table class="logs-table">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Usu√°rio</th>
          <th>A√ß√£o</th>
          <th>IP</th>
          <th>Descri√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let log of auditLogs" class="audit-row">
          <td class="date-cell">
            {{ formatDate(log.criadoEm) }}
          </td>
          
          <td class="user-cell">
            {{getUserName(log)}}
          </td>
          
          <td class="action-cell">
            <span class="action-badge">
              {{actionDescriptions[log.acao]}}
            </span>
          </td>
          
          <td class="ip-cell">
            {{log.enderecoIp || '-'}}
          </td>
          
          <td class="description-cell">
            <span class="description-text" [title]="log.descricao">
              {{log.descricao}}
            </span>
          </td>
          
          <td class="actions-cell">
            <button 
              class="btn-icon btn-view" 
              (click)="showDetails(log)"
              title="Ver detalhes">
              ‚Üí
            </button>
            <button 
              *ngIf="isUndoable(log)"
              class="btn-icon btn-undo" 
              (click)="confirmUndo(log)"
              [disabled]="undoingLogId === log.id"
              title="Desfazer altera√ß√£o">
              <span *ngIf="undoingLogId === log.id" class="spinner-small"></span>
              <span *ngIf="undoingLogId !== log.id">‚Ü∂</span>
            </button>
          </td>
        </tr>
        
        <!-- Empty state -->
        <tr *ngIf="auditLogs.length === 0">
          <td colspan="6" class="empty-state">
            Nenhum log de auditoria encontrado
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagina√ß√£o -->
  <div *ngIf="!loading && totalPages > 1" class="pagination">
    <div class="pagination-info">
      Mostrando {{(currentPage - 1) * itemsPerPage + 1}} - 
      {{currentPage * itemsPerPage > totalItems ? totalItems : currentPage * itemsPerPage}} de {{totalItems}} registros
    </div>
    
    <div class="pagination-controls">
      <button 
        class="btn-page" 
        [disabled]="currentPage === 1"
        (click)="changePage(1)">
        ¬´¬´
      </button>
      
      <button 
        class="btn-page" 
        [disabled]="currentPage === 1"
        (click)="changePage(currentPage - 1)">
        ¬´
      </button>
      
      <button 
        *ngFor="let page of getPageNumbers()" 
        class="btn-page"
        [class.active]="page === currentPage"
        (click)="changePage(page)">
        {{page}}
      </button>
      
      <button 
        class="btn-page" 
        [disabled]="currentPage === totalPages"
        (click)="changePage(currentPage + 1)">
        ¬ª
      </button>
      
      <button 
        class="btn-page" 
        [disabled]="currentPage === totalPages"
        (click)="changePage(totalPages)">
        ¬ª¬ª
      </button>
    </div>
  </div>
</div>

<!-- Modal de confirma√ß√£o de undo -->
<div *ngIf="showUndoConfirm && logToUndo" class="modal-overlay" (click)="cancelUndo()">
  <div class="modal-content undo-confirm-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirmar Rollback</h3>
      <button class="btn-close" (click)="cancelUndo()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="undo-confirm-content">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <p class="confirm-message">
          Tem certeza que deseja desfazer esta altera√ß√£o?
        </p>

        <div class="undo-details">
          <div class="detail-row">
            <span class="label">A√ß√£o:</span>
            <span class="value">{{actionDescriptions[logToUndo.acao]}}</span>
          </div>
          <div class="detail-row">
            <span class="label">Descri√ß√£o:</span>
            <span class="value">{{logToUndo.descricao}}</span>
          </div>
          <div class="detail-row">
            <span class="label">Usu√°rio:</span>
            <span class="value">{{getUserName(logToUndo)}}</span>
          </div>
          <div class="detail-row">
            <span class="label">Data/Hora:</span>
            <span class="value">{{formatDate(logToUndo.criadoEm)}}</span>
          </div>
        </div>

        <div class="undo-warning">
          <strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita e pode afetar outros dados relacionados.
        </div>

        <!-- Resultado do undo -->
        <div *ngIf="undoResult" class="undo-result" [ngClass]="{'success': undoResult.success, 'error': !undoResult.success}">
          <div class="result-icon">{{undoResult.success ? '‚úÖ' : '‚ùå'}}</div>
          <div class="result-message">{{undoResult.message}}</div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="cancelUndo()" [disabled]="undoingLogId !== null">
        Cancelar
      </button>
      <button 
        class="btn btn-danger" 
        (click)="executeUndo()" 
        [disabled]="undoingLogId !== null">
        <span *ngIf="undoingLogId !== null" class="spinner-small"></span>
        <span *ngIf="undoingLogId === null">Confirmar Rollback</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal de detalhes -->
<div *ngIf="showLogDetails && selectedLog" class="modal-overlay" (click)="closeDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalhes do Log</h3>
      <button class="btn-close" (click)="closeDetails()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="detail-grid">
        <div class="detail-item">
          <label>ID:</label>
          <span>{{selectedLog.id}}</span>
        </div>
        
        <div class="detail-item">
          <label>Data/Hora:</label>
          <span>{{formatDate(selectedLog.criadoEm)}}</span>
        </div>
        
        <div class="detail-item">
          <label>Usu√°rio:</label>
          <span>{{getUserName(selectedLog)}}</span>
        </div>
        
        <div class="detail-item">
          <label>A√ß√£o:</label>
          <span>{{actionDescriptions[selectedLog.acao]}}</span>
        </div>
        
        <div class="detail-item" *ngIf="selectedLog.entidade">
          <label>Entidade:</label>
          <span>{{getEntityDisplayName(selectedLog.entidade)}}</span>
        </div>
        
        <div class="detail-item" *ngIf="selectedLog.entidadeId">
          <label>ID da Entidade:</label>
          <span>{{selectedLog.entidadeId}}</span>
        </div>
        <div class="detail-item" *ngIf="selectedLog.enderecoIp">
          <label>IP:</label>
          <span>{{selectedLog.enderecoIp}}</span>
        </div>
        
        <div class="detail-item full-width">
          <label>Descri√ß√£o:</label>
          <span>{{selectedLog.descricao}}</span>
        </div>
      </div>
      
      <!-- Dados anteriores -->
      <div *ngIf="selectedLog.dadosAnteriores" class="data-section">
        <h4>Dados Anteriores:</h4>
        <pre class="json-data">{{formatJson(selectedLog.dadosAnteriores)}}</pre>
      </div>
      
      <!-- Novos dados -->
      <div *ngIf="selectedLog.dadosNovos" class="data-section">
        <h4>Novos Dados:</h4>
        <pre class="json-data">{{formatJson(selectedLog.dadosNovos)}}</pre>
      </div>
    </div>
  </div>
</div>