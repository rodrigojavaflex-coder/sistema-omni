<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start" *ngIf="isNative">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Nova Vistoria</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-card class="card">
    <ion-item class="datetime-item">
      <ion-label position="stacked">Data/Hora</ion-label>
      <ion-input [value]="datavistoriaDisplay" readonly="true"></ion-input>
      <ion-button
        fill="clear"
        size="small"
        slot="end"
        aria-label="Atualizar data/hora"
        (click)="atualizarDataHora()"
      >
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-item>
  </ion-card>

  <ion-card class="card" *ngIf="loadingAndamento || vistoriasEmAndamento.length > 0">
    <ion-item>
      <ion-label position="stacked">Vistorias em andamento</ion-label>
    </ion-item>
    <ion-item *ngIf="loadingAndamento">
      <ion-spinner name="crescent"></ion-spinner>
      <ion-label>Carregando vistorias...</ion-label>
    </ion-item>
    <ion-list *ngIf="!loadingAndamento && vistoriasEmAndamento.length > 0">
      <ion-item *ngFor="let vistoria of vistoriasEmAndamento">
        <ion-label>
          <h3>{{ vistoria.veiculo?.descricao || 'Veículo' }}</h3>
          <p>
            Motorista: {{ vistoria.motorista?.nome || '---' }}
            <span *ngIf="vistoria.motorista?.matricula">
              • Matricula: {{ formatarMatricula(vistoria.motorista?.matricula || '') }}
            </span>
          </p>
          <p>
            Data: {{ vistoria.datavistoria | date:'short' }}
          </p>
        </ion-label>
        <ion-button fill="outline" (click)="continuarVistoria(vistoria)">
          Continuar
        </ion-button>
      </ion-item>
    </ion-list>
  </ion-card>

  <ion-card class="card">
    <ion-item>
      <ion-label position="stacked">Veículo</ion-label>
      <ion-searchbar
        [debounce]="350"
        placeholder="Buscar por descrição ou placa"
        [value]="veiculoSearch"
        (ionInput)="onBuscarVeiculos($event)"
        (ionClear)="limparVeiculo()"
      ></ion-searchbar>
    </ion-item>
    <ion-list *ngIf="loadingVeiculos">
      <ion-item>
        <ion-spinner name="crescent"></ion-spinner>
        <ion-label>Buscando veículos...</ion-label>
      </ion-item>
    </ion-list>
    <ion-list *ngIf="!loadingVeiculos && veiculos.length > 0">
      <ion-item
        button
        class="selection-item"
        [class.is-selected]="selectedVeiculo?.id === veiculo.id"
        *ngFor="let veiculo of veiculos"
        (click)="selecionarVeiculo(veiculo)"
      >
        <ion-label>
          <h3>{{ veiculo.descricao }}</h3>
          <p>{{ veiculo.placa }}</p>
        </ion-label>
      </ion-item>
    </ion-list>
    <ion-item *ngIf="selectedVeiculo">
      <ion-label>
        <p>Odômetro atual: {{ ultimoOdometro === null ? 'Sem histórico' : (ultimoOdometro | number:'1.0-0') }}</p>
        <p>Combustível: {{ selectedVeiculo.combustivel || '-' }}</p>
      </ion-label>
    </ion-item>
  </ion-card>

  <ion-card class="card">
    <ion-item>
      <ion-label position="stacked">Motorista</ion-label>
      <ion-searchbar
        [debounce]="350"
        placeholder="Buscar por nome, matrícula ou CPF"
        [value]="motoristaSearch"
        (ionInput)="onBuscarMotoristas($event)"
        (ionClear)="limparMotorista()"
      ></ion-searchbar>
    </ion-item>
    <ion-list *ngIf="loadingMotoristas">
      <ion-item>
        <ion-spinner name="crescent"></ion-spinner>
        <ion-label>Buscando motoristas...</ion-label>
      </ion-item>
    </ion-list>
    <ion-list *ngIf="!loadingMotoristas && motoristas.length > 0">
      <ion-item
        button
        class="selection-item"
        [class.is-selected]="selectedMotorista?.id === motorista.id"
        *ngFor="let motorista of motoristas"
        (click)="selecionarMotorista(motorista)"
      >
        <ion-label>
          <h3>{{ motorista.nome }}</h3>
          <p>Matrícula: {{ formatarMatricula(motorista.matricula) }}</p>
        </ion-label>
      </ion-item>
    </ion-list>
  </ion-card>

  <ion-card class="card">
    <ion-item>
      <ion-label position="stacked">Odômetro</ion-label>
      <ion-input
        type="text"
        inputmode="numeric"
        placeholder="Ex: 12345"
        class="campo-destaque"
        [value]="odometroDisplay"
        (ionInput)="onOdometroInput($event.detail.value)"
      ></ion-input>
    </ion-item>
    <ion-item>
      <ion-label position="stacked">% Bateria</ion-label>
      <ion-input
        type="number"
        [(ngModel)]="bateria"
        placeholder="0 a 100"
        min="0"
        max="100"
        [disabled]="!isBateriaObrigatoria()"
        class="campo-destaque"
      ></ion-input>
    </ion-item>
  </ion-card>

  <ion-text color="danger" *ngIf="!canStart && startValidationMessage">
    <p class="error-message">{{ startValidationMessage }}</p>
  </ion-text>

  <ion-text color="danger" *ngIf="errorMessage">
    <p class="error-message">{{ errorMessage }}</p>
  </ion-text>

  <div class="actions">
    <ion-button expand="block" [disabled]="!canStart || isSaving" (click)="iniciarVistoria()">
      <ion-spinner *ngIf="isSaving" name="crescent"></ion-spinner>
      <span *ngIf="!isSaving">Iniciar Vistoria</span>
    </ion-button>
  </div>
</ion-content>
